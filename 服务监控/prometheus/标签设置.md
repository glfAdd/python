##### 文档

```
https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config
```

##### 作用

```
自定义标签，通过标签可以进行查询过滤
```

##### 默认标签

- 当 Prometheus 加载 Target 实例完成后, 这些 Target 时候都会包含一些默认的标签
- 这些标签将会告诉Prometheus如何从该Target实例中获取监控数据
- __前缀不会写到metrics指标里面的，因为这属于系统内置标签, 没有前缀的是可以写到metrics指标中

```
__address__：当前Target实例的访问地址<host>:<port>
__scheme__：采集目标服务访问地址的HTTP Scheme，HTTP或者HTTPS
__metrics_path__：采集目标服务访问地址的访问路径
__param_<name>：采集任务目标服务的中包含的请求参数
```

##### relabel_configs和metric_relable_configs 区别

```
relabel_configs是针对target指标采集前和采集中的筛选，而metric_relabel_configs是针对指标采集后的筛选

relabel_configs 时指标还没有采集
metric_relabel_configs使用的时候指标已经采集过了
```

## relabel_configs

##### 功能

```
relabel_configs是针对target指标采集前和采集中的筛选

Prometheus 允许用户在采集任务设置中，通过 relabel_configs 来添加自定义的 Relabeling 的额过程，来对标签进行指定规则的重写。 

Prometheus 加载 Targets 后，这些 Targets 会自动包含一些默认的标签，Target 以 __ 作为前置的标签是在系统内部使用的，这些标签不会被写入到样本数据中。

每次增加 Target 时会自动增加一个 instance 标签, 值是对应 Target 实例的 __address__ 值
```

##### 关键字

| 字段          | 类型 | 说明                           |
| ------------- | ---- | ------------------------------ |
| action        |      | 指定动作                       |
| source_labels | list | 指定需要被action所操作的原标签 |
| regex         |      | 匹配正则                       |
| replacement   |      |                                |
| target_label  |      |                                |

##### relabel_action

| relabel_action | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| replace        | 默认. 根据 regex 的配置匹配 source_labels 标签的值, 匹配到的值写入 target_label. 如果有多个匹配组，则可以使用 ${1}, ${2} 确定写入的内容。如果没匹配到任何内容则不对 target_label 进行重写 |
| keep           | 丢弃 source_labels 的值中没匹配到 regex 正则表达式内容的 Target 实例 |
| drop           | 丢弃 source_labels 的值中匹配到 regex 正则表达式内容的 Target 实例 |
| hashmod        | 将 target_label 设置为关联的 source_label 的哈希模块         |
| labelmap       | 根据 regex 去匹配 Target 实例所有标签的名称（注意是名称），并且将捕获到的内容作为为新的标签名称，regex 匹配到标签的的值作为新标签的值 |
| labeldrop      | 对 Target 标签进行过滤，会移除匹配过滤条件的所有标签         |
| labelkeep      | 对 Target 标签进行过滤，会移除不匹配过滤条件的所有标签       |

##### 示例

```yml
scrape_configs:
  - job_name: web_node
    metrics_path: /metrics
    scheme: http
    static_configs:
      - targets:
          - '10.160.2.107:9100'
          - '192.168.1.100:9100'     
        labels: #自定义标签
          server: nginx #将上面2个主机打上server标签，值为nginx
          
  - job_name: mysql_node
    static_configs:
      - targets:
          - '10.160.2.110:9100'
          - '192.168.1.111:9100'
    metric_relable_configs: #声明要重命名标签
      - action: replace #指定动作，replace代表替换标签，也是默认动作
        source_labels: #指定需要被action所操作的原标签
          - job
        regex: (.*) #原标签里的匹配条件，符合条件的原标签才会被匹配，支持正则
        replacement: $1 #原标签需要被替换的部分，$1代表regex正则的第一个分组
        target_label: idc #将$1内容赋值给idc标签
      - action: drop #正则匹配要删除标签
        regex: 192.168.100.* #正则匹配标签值
        source_labels: #需要进行正则匹配的原标签
          - __address__
      - action: labeldrop #直接删除标签
        regex: job #直接写标签名即可
```

## metric_relabel_configs

##### 功能

```
metric_relabel_configs是针对指标采集后的筛选

存储数据之前可以使用 metric_relabel_configs 重新标记
```

